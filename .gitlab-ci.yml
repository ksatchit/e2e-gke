## TODO: Modularize the gitlab yaml to reuse templates

## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
    #  - STATEFUL-APP-DEPLOY
    #  -  APP-FUNC-TEST
  - APP-CHAOS-TEST
  - CLUSTER-CLEANUP

variables: 
  utils_path: "/openebs/e2e-gke/script/utils"

## Setup the kubernetes cluster

gke-cluster:
  image: atulabhi/kops:v9
  stage: CLUSTER-SETUP 
  script:
    - chmod 775 ./script/gke      
    - ./script/gke
  artifacts:
    paths:
      - .kube/

## Setup OpenEBS control plane

openebs-gke-deploy:
  image: atulabhi/kops:v9
  stage: PROVIDER-INFRA-SETUP
  dependencies:
    - gke-cluster
  script: 
   - chmod 775 ./script/provider/infra-setup
   - ./script/provider/infra-setup
  artifacts:
    paths:
      - .kube-openebs/

## Define a job template for app deployers

.chaos_test_template:
  image: atulabhi/kops:v9
  stage: APP-CHAOS-TEST
  when: always 
  artifacts:
    paths: 
      - .kube-openebs/

repl-kill-{percona-jiva}:
  extends: .chaos_test_template #dependencies: percona-jiva
  script:
   - ./script/apps/percona/chaos/jiva/volume-replica-failure


cleanup-gke:
  when: always
  image: atulabhi/kops:v9
  dependencies:
    - gke-cluster
  stage: CLUSTER-CLEANUP
  script: 
    - chmod 755 ./script/gke-cleanup
    - ./script/gke-cleanup
